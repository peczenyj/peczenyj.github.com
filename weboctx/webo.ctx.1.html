<html>
  <head>
    <title>test webo ctx using lefigaro / (gold)</title>
    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
<script>
  window.googletag = window.googletag || {cmd: []};
  googletag.cmd.push(function() {
    googletag.defineSlot('/1056029/test-webo-contextual', [300, 300], 'div-gpt-ad-1620653642627-0').addService(googletag.pubads());
    googletag.pubads().enableSingleRequest();
    googletag.enableServices();
  });
</script>
  </head>
  
  <body>
	<p>test webo ctx using lefigaro / (ad: gold)</p>  
    <!-- /1056029/test-webo-contextual -->
<div id='div-gpt-ad-1620653642627-0' style='width: 300px; height: 300px;'>

</div>

  <script>
  var alreadyCalled = false; // global state for the function below
  function clientSetupGAMAndDisplayADs(profile){
    if ( alreadyCalled ) {
      return
    }
    alreadyCalled = true;
    
    console.log("clientSetupGAMAndDisplayADs", profile);

    
    // GAM setup ...
    googletag.cmd.push(function() {      
      for(var key in profile){
	var value = profile[key];
	
	googletag.pubads().setTargeting(key, value);
      }
    });  
    
    // and display
    googletag.cmd.push(function() {  
      googletag.display('div-gpt-ad-1620653642627-0');
    });
  }
  
  var TOKEN = 'topsecret2',
    targetURL = 'https://www.lefigaro.fr' , // instead of document.URL
    urlProfileAPI = 'https://ctx-preprod.weborama.com/api/profile?token=' + TOKEN + '&url=' + encodeURIComponent(targetURL),
    method = 'GET',
    timeout = 50, // milliseconds
    xhr = new XMLHttpRequest();

  xhr.open(method, urlProfileAPI, true);
  xhr.timeout = timeout;
  xhr.responseType = 'json';
  xhr.onreadystatechange = function () {
    if (this.readyState == 4) {
      var profile = {};
      if (this.status == 200) {
	profile = this.response;
	console.log("request to contextual api: success");
      } else {
	console.log("request to contextual api: unexpected status code", this.status, this.response);      
      }
      clientSetupGAMAndDisplayADs(profile);
    }
  };
  xhr.ontimeout = function(e){
    console.log("contextual api timeout",e);
  };
  xhr.onerror = function(e){
    console.log("contextual api error",e);
  };

  xhr.send(null);
  
  // fallback
  setTimeout(clientSetupGAMAndDisplayADs, timeout,{});
  </script>
    
  </body>
</html>
